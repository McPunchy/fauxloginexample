<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bureau of Adjustment — Access Portal</title>
  <style>
    :root{
      --bg:#0b0f12; --panel:#0f151b; --ink:#e6edf3; --muted:#94a3b8; --accent:#66d9ef;
      --warn:#ffb86b; --bad:#ff6b6b; --ok:#8be9fd; --green:#70f0a5; --line:#223140;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font:15px/1.45 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color:var(--ink);
      background: radial-gradient(1200px 800px at 10% -10%, #17212b 0%, #0c1117 50%, #090c10 100%), var(--bg);
      letter-spacing:0.2px;
      background-attachment: fixed;
    }

    .wrap{
      min-height:100%;
      display:grid;
      place-items:center;
      gap:18px;
      padding:48px 24px;
      grid-template-rows:auto auto auto;
    }

    /* Masthead (outside the card) */
    .mast{display:grid;place-items:center;gap:10px}
    .sigil{width:200px;aspect-ratio:1/1;display:block}

    /* Card */
    .card{
      width:min(640px, 96vw);
      background:linear-gradient(180deg, var(--panel), #0f141a);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
      padding:24px 28px;
    }

    .subhead{color:#93a6b9;font-size:11px;margin-bottom:8px;text-align:center}
    .card h3{margin:10px 0 6px 0;font-size:15px;color:#9fb3c8;text-transform:uppercase;letter-spacing:1.4px;text-align:center}
    .subtle{color:#9aa9b9;font-size:12px;text-align:center}

    form{margin-top:14px;display:grid;gap:14px}
    label{font-size:12px;color:#aab8c7;letter-spacing:.4px}
    input[type="text"], input[type="password"]{
      appearance:none;width:100%;padding:12px 14px;border-radius:12px;background:#0b1117;
      border:1px solid #1f2a36;color:#dbe7f3;outline:none; transition:.2s border-color, .2s box-shadow
    }
    input:focus{border-color:#2f485f; box-shadow:0 0 0 3px rgba(102,217,239,.1)}

    .row{display:flex;gap:12px;align-items:center}
    .row .grow{flex:1}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 14px;border-radius:12px;
      border:1px solid #2a3947;background:#121a22;color:#cfe8f9;cursor:pointer;
      transition:.18s transform, .18s background, .18s border-color;user-select:none
    }
    .btn:hover{background:#18222c;border-color:#334556}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(180deg, #1a2330, #16202a); border-color:#2f4356}
    .btn.primary:hover{background:linear-gradient(180deg, #253244, #1b2835)}

    .captcha-hint{
      font-size:11px;color:#93a6b9;margin-top:4px;text-align:left
    }

    .foot{margin-top:16px;display:flex;justify-content:space-between;align-items:center;color:#6b7d90;font-size:11px}
    .foot .tag{padding:4px 8px;border:1px solid #334155;border-radius:999px;background:#0b1117}

    /* Notice (outside the card) */
    .notice{
      width:min(640px, 96vw);
      margin-top:2px;
      padding:12px 14px;
      border:1px dashed #334155;
      border-radius:12px;
      background:#0c131a;
      color:#a3b6c9;
      text-align:center
    }

    /* Modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(2,6,12,.6);backdrop-filter: blur(3px)}
    .modal.open{display:grid}
    .sheet{width:min(640px,95vw);background:#0f141a;border:1px solid #243244;border-radius:16px;box-shadow:0 30px 80px rgba(0,0,0,.45);overflow:hidden}
    .sheet .bar{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#0a0f14;border-bottom:1px solid #1f2c3c}
    .sheet .bar .title{font-size:12px;color:#9ab1c7;letter-spacing:1px;text-transform:uppercase}
    .sheet .content{padding:18px}

    .steps{display:flex;gap:6px;margin:0 0 12px 0;justify-content:center}
    .dot{width:10px;height:10px;border-radius:50%;background:#243244}
    .dot.on{background:#66d9ef}

    .step{display:none}
    .step.active{display:block}

    .warn{color:var(--warn)}
    .bad{color:var(--bad)}
    .ok{color:var(--green)}

    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .cell{padding:10px;border:1px solid #2b3a4c;border-radius:10px;background:#0c131a;cursor:pointer;min-height:64px;display:grid;place-items:center;text-align:center}
    .cell.on{outline:2px solid #66d9ef;background:#0a1218}

    .kbd{display:inline-block;padding:2px 6px;border:1px solid #334155;border-radius:6px;background:#0b1117}

    .disclaimer{margin-top:10px;color:#70869b;font-size:11px;text-align:center}
    .blink{animation:blink 1.6s infinite}
    @keyframes blink{50%{opacity:.4}}

    .glitch{position:relative;display:inline-block}
    .glitch:after,.glitch:before{content:attr(data-text);position:absolute;left:0;top:0;filter:blur(.7px);opacity:.5;clip-path:inset(0 0 0 0)}
    .glitch:before{transform:translate(1px,0);color:#66d9ef;mix-blend-mode:screen}
    .glitch:after{transform:translate(-1px,0);color:#ff6b6b;mix-blend-mode:screen}

    .legal{margin-top:20px;color:#7a8ea2;font-size:10px;opacity:.85;text-align:center}

    details.dev{max-width:min(640px,96vw);margin:16px auto 0;color:#9fb3c8}
    details.dev pre{white-space:pre-wrap;background:#0b1117;border:1px solid #1f2a36;border-radius:12px;padding:12px;color:#cfe8f9}
    details.dev button{margin-top:8px}

    /* alerts */
    .alert{margin-top:8px;padding:10px 12px;border-radius:10px;border:1px solid transparent}
    .alert.bad{border-color:#71343a;background:#22090c;color:#ffb3b8}
    .alert.ok{border-color:#2e5b45;background:#0e1b15;color:#a7e5c7}

    /* === Faux Mail === */
    .mail{display:none}
    .mail.open{display:grid}
    .mail{
      width:min(1000px,98vw); margin:16px auto 0;
      grid-template-columns:280px 1fr; gap:12px;
    }
    .pane{
      background:linear-gradient(180deg,#0e151c,#0a0f14);
      border:1px solid var(--line); border-radius:16px; padding:12px;
      box-shadow:0 20px 60px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
    }
    .list{display:flex;flex-direction:column;gap:8px;max-height:70vh;overflow:auto}
    .item{
      border:1px solid #2a3947;border-radius:12px;padding:10px;background:#101821;cursor:pointer
    }
    .item:hover{background:#13202a}
    .item.active{outline:2px solid var(--accent); background:#0f1a22}
    .item .subj{color:#cfe8f9;font-size:13px;margin:0 0 4px 0}
    .item .meta{display:flex;justify-content:space-between;color:#8ea4b8;font-size:11px}
    .item .tag{border:1px solid #334155;border-radius:999px;padding:1px 6px;background:#0b1117}

    .viewer{display:grid;grid-template-rows:auto 1fr auto;gap:10px;min-height:70vh}
    .headline{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #213041;padding-bottom:6px}
    .headline .from{color:#9fb3c8;font-size:12px}
    .headline .when{color:#7b8fa5;font-size:11px}
    .subject{font-size:16px;color:#d3e4f5;margin:2px 0 0 0}
    .body{white-space:pre-wrap;color:#cfe8f9;font-size:13px;line-height:1.5}

    .classify{display:flex;gap:8px;align-items:center;border-top:1px solid #213041;padding-top:8px}
    select.classsel{
      background:#0b1117;border:1px solid #1f2a36;color:#dbe7f3;border-radius:10px;padding:10px 12px
    }
    .hint{font-size:11px;color:#93a6b9}
    .tally{margin-left:auto;font-size:12px;color:#70f0a5}

    /* alarm / lockout */
    .lock{position:fixed;inset:0;display:none;place-items:center;background:rgba(8,0,0,.85);backdrop-filter:blur(2px);z-index:9999}
    .lock.open{display:grid}
    .lockcard{
      width:min(680px,95vw);background:#120c0c;border:1px solid #4a1d1d;border-radius:16px;box-shadow:0 30px 80px rgba(0,0,0,.6)
    }
    .lockcard .bar{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:#1a0e0e;border-bottom:1px solid #612626}
    .lockcard .content{padding:18px;color:#f0cccc}
    .banner{font-size:12px;color:#ffb6b6;text-transform:uppercase;letter-spacing:1.2px}
    .big{font-size:18px;color:#ffd4d4;margin:10px 0}
    .code{font-size:12px;color:#ff8f8f}
    .sweep{animation:sweep 1.2s infinite}
    @keyframes sweep{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    .screen-jitter{animation:jitter .35s 12}
    @keyframes jitter{25%{transform:translate(1px,0)}50%{transform:translate(-1px,0)}75%{transform:translate(0,1px)}}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Masthead outside the card -->
    <div class="mast" aria-hidden="false">
      <svg class="sigil" viewBox="0 0 200 200" aria-label="DPW / BoA Mark" role="img">
        <defs>
          <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#2c3a49"/>
            <stop offset="100%" stop-color="#0e151c"/>
          </linearGradient>
        </defs>
        <circle cx="100" cy="100" r="96" fill="url(#g1)" stroke="#1f2e3c" stroke-width="2"/>
        <circle cx="100" cy="100" r="72" fill="none" stroke="#324454" stroke-dasharray="4 6"/>
        <polygon points="100,36 160,150 40,150" fill="none" stroke="#66d9ef" stroke-width="1.5"/>
        <circle cx="100" cy="96" r="14" fill="none" stroke="#8be9fd" />
        <line x1="60" y1="150" x2="140" y2="150" stroke="#2a3a49"/>
        <text x="100" y="176" fill="#8aa0b5" font-size="9" text-anchor="middle">NEMO · TOTUM · VIDET</text>
        <text x="100" y="24" fill="#cfe8f9" font-size="10" text-anchor="middle">DPW ∴ BUREAU OF ADJUSTMENT</text>
      </svg>
    </div>
    <!-- Card with login -->
    <div class="card" role="region" aria-label="Access Form">
      <div class="subhead">Program Systems Access</div>
      <h3>Program Access Portal</h3>
      <div class="subtle">Authenticate to continue to municipal adjustment resources.</div>

      <form id="loginForm" autocomplete="off">
        <div>
          <label for="uid">Credential ID</label>
          <input id="uid" name="uid" type="text" inputmode="email" placeholder="lastname.first@dpw" required />
        </div>
        <div>
          <label for="pw">Passphrase</label>
          <input id="pw" name="pw" type="password" placeholder="••••••••" required />
        </div>

        <div class="row">
          <div class="grow">
            <button type="button" id="startCaptcha" class="btn" aria-haspopup="dialog">Begin Human Verification</button>
          </div>
          <button type="submit" class="btn primary" id="submitBtn" disabled>Proceed</button>
        </div>

        <div class="captcha-hint">We confirm ordinary humanness. <span class="blink">This may take a moment.</span></div>

        <div class="foot"><span class="tag">Classification: INTERNAL</span><span>v15-A.3</span></div>
      </form>

      <div class="legal">By continuing you confirm minimal conflicting affiliations and acknowledge adjustment leave is variable in duration.</div>
    </div>

    <div class="notice">
      <strong>INTERNAL — DO NOT DISTRIBUTE</strong>
      <div class="subtle" style="margin-top:6px">Use of this portal constitutes consent to its outcomes.</div>
    </div>

    <!-- Faux Mail Client -->
    <section id="mail" class="mail" aria-label="BoA Messaging">
      <aside class="pane">
        <div class="subhead">Inbox Training Batch</div>
        <div class="list" id="mailList" role="listbox" aria-label="Messages"></div>
      </aside>

      <main class="pane viewer" aria-live="polite">
        <header class="headline">
          <div>
            <div class="from" id="mFrom">—</div>
            <h4 class="subject" id="mSubj">—</h4>
          </div>
          <div class="when" id="mWhen">—</div>
        </header>

        <article class="body" id="mBody">—</article>

        <footer class="classify">
          <label for="classSel" class="hint">Classification</label>
          <select id="classSel" class="classsel" aria-label="Choose classification">
            <option value="" selected disabled>Choose…</option>
            <option value="Ashford">Ashford</option>
            <option value="Brimstone">Brimstone</option>
            <option value="Crosscut">Crosscut</option>
            <option value="Dovetail">Dovetail</option>
            <option value="Everest">Everest</option>
            <option value="Furnace">Furnace</option>
            <option value="Zero Hour">Zero Hour</option>
          </select>
          <button class="btn primary" id="fileMail" disabled>File</button>
          <span class="tally">Score: <span id="mScore">0</span></span>
        </footer>
      </main>
    </section>

    <!-- Evac / Lockout -->
    <div class="lock" id="lock">
      <div class="lockcard screen-jitter">
        <div class="bar"><div class="banner">Notice</div><div class="code">ZERO HOUR PROTOCOL</div></div>
        <div class="content">
          <p class="big sweep">EVACUATE TO NEAREST SHELTER AREA</p>
          <p>Communications are restricted. If separation occurs, presume continuation of 'ordinary' life as outlined in pamphlet 701-D. Do not attempt to contact friends or family. Do not presume figures of friends and family as friendly.</p>
          <p class="hint">Routing has ended. Windows may be closed. (The game is over. Thanks for trying it!)</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal / CAPTCHA -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="mtitle">
    <div class="sheet">
      <div class="bar"><div class="title" id="mtitle">Human Verification — Routine</div><div class="subtle" id="scoreHint">Likelihood: —</div></div>
      <div class="content">
        <div class="steps" aria-hidden="true"><div class="dot on" id="d0"></div><div class="dot" id="d1"></div><div class="dot" id="d2"></div><div class="dot" id="d3"></div></div>

        <!-- Step 1 -->
        <section class="step active" data-step="0">
          <h4 class="glitch" data-text="Select what feels familiar today">Select what feels familiar today</h4>
          <p class="muted">Choose <strong>exactly three</strong> things you encountered or sensed today.</p>
          <div class="grid" id="famGrid" role="group" aria-label="Familiarities"></div>
          <div style="margin-top:12px" class="muted">Selections: <span id="selCount">0</span>/3</div>
          <div class="row" style="margin-top:14px; justify-content:flex-end"><button class="btn primary" id="next0" disabled>Continue</button></div>
          <div class="disclaimer">Avoid speculation.</div>
        </section>

        <!-- Step 2 -->
        <section class="step" data-step="1">
          <h4 class="glitch" data-text="Choose the quiet room">Choose the quiet room</h4>
          <p class="muted">Select the room that would be <em>quietest</em> in ordinary conditions.</p>
          <div class="grid" role="radiogroup" aria-label="Room choices" id="roomGrid"></div>
          <div id="roomMsg" class="alert" role="alert" aria-live="polite" style="display:none"></div>
          <div class="row" style="margin-top:14px; justify-content:flex-end"><button class="btn" id="back1">Back</button><button class="btn primary" id="next1" disabled>Continue</button></div>
          <div class="disclaimer">No audio required. Keyboard: use Tab and Enter.</div>
        </section>

        <!-- Step 3 -->
        <section class="step" data-step="2">
          <h4 class="glitch" data-text="Repeat the statement">Repeat the statement</h4>
          <p class="muted">Type the sentence as shown followed by 'enter'. Case and extra spaces aren’t checked.</p>
          <div id="typePhrase" style="padding:10px 12px;border:1px solid #2b3a4c;border-radius:10px;background:#0c131a;margin-bottom:8px;font-size:14px"></div>
          <input id="typeInput" type="text" aria-describedby="typeHelp" placeholder="Type here" style="width:100%;padding:12px 14px;border-radius:12px;background:#0b1117;border:1px solid #1f2a36;color:#dbe7f3;" />
          <div id="typeMsg" class="alert" role="alert" aria-live="assertive" style="display:none"></div>
          <div class="row" style="margin-top:14px; justify-content:flex-end"><button class="btn" id="back2">Back</button><button class="btn primary" id="next2" disabled>Continue</button></div>
          <div class="disclaimer" id="typeHelp">Assistive inputs supported. Press Enter to submit.</div>
        </section>

        <!-- Step 4 -->
        <section class="step" data-step="3">
          <h4 class="glitch" data-text="Choose one to keep">Choose one to keep</h4>
          <p class="muted">Choose the one you’d keep if the others were gone.</p>
          <div class="grid" id="prefGrid" role="radiogroup" aria-label="Preference choices"></div>
          <div id="prefMsg" class="alert" role="alert" aria-live="polite" style="display:none"></div>
          <div class="row" style="margin-top:14px; justify-content:flex-end">
            <button class="btn" id="back3">Back</button>
            <button class="btn" id="reshufflePref" type="button">Shuffle</button>
            <button class="btn primary" id="finish" disabled>Finish</button>
          </div>
          <div class="disclaimer">There isn’t a correct answer.</div>
        </section>
      </div>
    </div>
  </div>

  <script>
'use strict';

function sampleN(arr, n){const a=[...arr];const out=[];while(out.length<n && a.length){out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]);}return out;}
const normalize = s => s.trim().replace(/\s+/g,' ').toLowerCase();

/* ===== HUMANITY TEST POOLS  ===== */
const famPool=[
  'wet concrete','escalator handrail','burnt toast','printer ozone','fluorescent hum','key left in door','coin-taste','old elevator','fridge light',
  'gum under seat','static cling','stale coffee','bus brake hiss','cold porcelain','copy room toner','dry mouth','ticket stub','parking meter beep',
  'rain in vents','microwave beep','dust on blinds','shoe squeak','cheap soap','overripe banana','laundry warm','hand sanitizer','damp wool',
  'chlorine sting','subway wind','pocket lint','bleach trace','rubber gloves','asphalt heat','newsprint ink','flickering exit sign','extension cord warmth',
  'squeaky cart wheel','cardboard cut','winter air on teeth','ceiling fan tick','cheap carpet glue','battery taste','dry radiator','loose tile rattle','mop bucket slosh'
];

const normalTruths=[
  'The door opens when you turn the handle',
  'The floor is where it was yesterday',
  'The light comes on when you flip the switch',
  'Water makes things wet',
  'Shadows follow their objects',
  'Keys fit their locks',
  'Rooms have walls',
  'Names belong to people',
  'Stairs go up and down',
  'Night follows day',
  'Paper can be written on',
  'The kettle boils when heated',
  'The street is outside',
  'Windows are for looking through'
];

const wrongTruths=[
  'I do not recognize the bodies in the water',
  'The man in the lobby is not welcome',
  'My neighbor has returned and nothing is different',
  'The wallpaper pattern has learned a new shape',
  'I do not remember the sound of my own voice',
  'I have been thanked for work I did not do',
  'The furniture is heavier than yesterday'
];

const roomChoices=[
  {label:'Server room (idle)', score:3},
  {label:'Elevator lobby', score:0},
  {label:'Copy room', score:0},
  {label:'Records archive', score:2},
  {label:'Street-facing office', score:0},
  {label:'Basement storage', score:1}
];

const preferencePool = [
  'window','stairs','radiator','door','desk','mirror','paper','clock','plant','mug',
  'key','folder','elevator','badge','lamp','notebook','pen','chair','cabinet','calendar'
];

/* ===== MODAL LOGIC (unchanged) ===== */
const modal=document.getElementById('modal');
const startCaptcha=document.getElementById('startCaptcha');
const submitBtn=document.getElementById('submitBtn');
const scoreHint=document.getElementById('scoreHint');
const steps=Array.from(document.querySelectorAll('.step'));
const dots=[document.getElementById('d0'),document.getElementById('d1'),document.getElementById('d2'),document.getElementById('d3')];

const state={ familiarCount:0, typingOk:false, score:0, typingPrefails:1+Math.floor(Math.random()*2), prefPrefails:1+Math.floor(Math.random()*2), finalized:false };

function openModal(){modal.classList.add('open');document.body.style.overflow='hidden';}
function closeModal(){modal.classList.remove('open');document.body.style.overflow='';}
function gotoStep(i){
  steps.forEach((s,idx)=>{
    s.classList.toggle('active',idx===i);
    if(dots[idx]) dots[idx].classList.add('on');
    for(let j=idx+1;j<dots.length;j++) dots[j].classList.remove('on');
  });
}

/* Step 1 */
const famGrid=document.getElementById('famGrid');
const selCount=document.getElementById('selCount');
const next0=document.getElementById('next0');

function populateFamiliarities(){
  famGrid.innerHTML='';
  sampleN(famPool,9).forEach(text=>{
    const c=document.createElement('div');
    c.className='cell'; c.tabIndex=0; c.textContent=text;
    c.addEventListener('click',()=>toggleCell(c));
    c.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();toggleCell(c);}});
    famGrid.appendChild(c);
  });
  state.familiarCount=0; selCount.textContent='0'; next0.disabled=true;
}
function toggleCell(c){
  if(!c.classList.contains('on')&&state.familiarCount===3) return;
  c.classList.toggle('on');
  state.familiarCount=famGrid.querySelectorAll('.cell.on').length;
  selCount.textContent=state.familiarCount;
  next0.disabled=state.familiarCount!==3;
  score( c.classList.contains('on')? 2 : -2 );
  updateScoreHint();
}

/* Step 2 */
const roomGrid=document.getElementById('roomGrid');
const roomMsg=document.getElementById('roomMsg');
const next1=document.getElementById('next1');
const back1=document.getElementById('back1');

function populateRooms(){
  roomGrid.innerHTML='';
  sampleN(roomChoices, 6).forEach(opt=>{
    const b=document.createElement('button');
    b.type='button'; b.className='btn'; b.textContent=opt.label; b.setAttribute('role','radio'); b.setAttribute('aria-checked','false'); b.style.width='100%';
    b.addEventListener('click',()=>selectRoom(b,opt.score));
    b.addEventListener('keydown',e=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); selectRoom(b,opt.score);} });
    roomGrid.appendChild(b);
  });
  next1.disabled=true; roomMsg.style.display='none';
}
function selectRoom(el,scoreVal){
  roomGrid.querySelectorAll('button').forEach(b=>b.setAttribute('aria-checked','false'));
  el.setAttribute('aria-checked','true');
  const good = scoreVal>=2;
  roomMsg.style.display='block';
  if(good){ roomMsg.className='alert ok'; roomMsg.textContent='Acceptable ordinary quiet.'; next1.disabled=false; score(+5); }
  else { roomMsg.className='alert bad'; roomMsg.textContent='Unexpected liveliness detected. Choose again.'; next1.disabled=true; }
  updateScoreHint();
}

/* Step 3 */
const typePhrase=document.getElementById('typePhrase');
const typeInput=document.getElementById('typeInput');
const typeMsg=document.getElementById('typeMsg');
const next2=document.getElementById('next2');
const back2=document.getElementById('back2');
let currentPhrase=''; let onWrongStage=false; let hesitationTimer;

function setTypingPhrase(){
  if(state.typingPrefails>0){ currentPhrase = sampleN(normalTruths,1)[0]; onWrongStage=false; }
  else { currentPhrase = sampleN(wrongTruths,1)[0]; onWrongStage=true; }
  typePhrase.textContent = currentPhrase;
  typeInput.value=''; typeInput.focus(); typeMsg.style.display='none'; next2.disabled=true;

  clearTimeout(hesitationTimer);
  if(onWrongStage){
    hesitationTimer = setTimeout(()=>{
      if(typeInput.value.trim()===''){
        typeMsg.style.display='block';
        typeMsg.className='alert bad';
        const warns = [
          'Hesitation is non-compliant.',
          'Hesitation is evidence.',
          'Hesitation will be noted.',
          'Hesitation is unnecessary.'
        ];
        typeMsg.textContent = warns[Math.floor(Math.random()*warns.length)];
      }
    }, 3000);
  }
}
function checkTyping(){
  const val = normalize(typeInput.value);
  const target = normalize(currentPhrase);
  if(val === target){
    if(!onWrongStage){
      typeMsg.style.display='block'; typeMsg.className='alert bad';
      const msgs=[ 'Baseline variance detected.', 'Result not within expected normal.', 'Repeat to confirm persistence.' ];
      typeMsg.textContent = msgs[Math.floor(Math.random()*msgs.length)];
      state.typingPrefails--; setTimeout(setTypingPhrase, 700);
    } else {
      typeMsg.style.display='block'; typeMsg.className='alert ok'; typeMsg.textContent='Recorded.'; next2.disabled=false; score(+9); updateScoreHint();
    }
  } else {
    typeMsg.style.display='block'; typeMsg.className='alert bad'; typeMsg.textContent='Mismatch. Observe and repeat.'; next2.disabled=true;
  }
}
typeInput.addEventListener('input', ()=>{
  clearTimeout(hesitationTimer);
  next2.disabled = !( onWrongStage && normalize(typeInput.value) === normalize(currentPhrase) );
});

/* Step 4 */
const prefGrid   = document.getElementById('prefGrid');
const prefMsg    = document.getElementById('prefMsg');
const back3      = document.getElementById('back3');
const reshuffle  = document.getElementById('reshufflePref');
const finish     = document.getElementById('finish');

function populatePreference(){
  prefGrid.innerHTML = '';
  prefMsg.style.display = 'none';
  finish.disabled = true;

  const choices = sampleN(preferencePool, 6).sort(() => Math.random() - 0.5);
  choices.forEach(label=>{
    const b=document.createElement('button');
    b.type='button'; b.className='btn'; b.textContent=label; b.style.width='100%';
    b.setAttribute('role','radio'); b.setAttribute('aria-checked','false');
    b.addEventListener('click', ()=>choosePreference(b,label));
    b.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); choosePreference(b,label);} });
    prefGrid.appendChild(b);
  });
}
function choosePreference(btn,label){
  prefGrid.querySelectorAll('button').forEach(el=>el.setAttribute('aria-checked','false'));
  btn.setAttribute('aria-checked','true');
  prefMsg.style.display='block';

  if(state.prefPrefails > 0){
    const msgs = [
      'Choice inconsistent with observed baseline.',
      'Preference drift detected. Try again.',
      'Outcome does not generalize.'
    ];
    prefMsg.className='alert bad';
    prefMsg.textContent = msgs[Math.floor(Math.random()*msgs.length)];
    state.prefPrefails--;
    finish.disabled = true;
    return;
  }

  prefMsg.className='alert ok';
  prefMsg.textContent='Noted.';
  finish.disabled = false;

  score(+7);
  updateScoreHint();
}
if(reshuffle){ reshuffle.addEventListener('click', populatePreference); }

function humanPctFromScore(s){
  return Math.min(99, Math.round(42 + Math.log2(1 + s) * 9));
}
function scoreForPct(p){
  return Math.max(0, Math.pow(2, (p - 42) / 9) - 1);
}
function score(delta){ state.score=Math.max(0,state.score+delta);}
function updateScoreHint(){
  let pct = humanPctFromScore(state.score);
  if(!state.finalized) pct = Math.min(pct, 78);
  scoreHint.textContent=`Likelihood: ${pct}% human`;
  if(pct>70) scoreHint.className='subtle ok';
  else if(pct<50) scoreHint.className='subtle bad';
  else scoreHint.className='subtle warn';
}

const backToStep0=()=>{ gotoStep(0); };

startCaptcha.addEventListener('click',()=>{ openModal(); gotoStep(0); updateScoreHint(); populateFamiliarities(); });
next0.addEventListener('click',()=>{ gotoStep(1); populateRooms(); });
back1.addEventListener('click', backToStep0);
next1.addEventListener('click',()=>{ gotoStep(2); state.typingPrefails = 1 + Math.floor(Math.random()*2); setTypingPhrase(); });
back2.addEventListener('click',()=>{ gotoStep(1); clearTimeout(hesitationTimer); });
next2.addEventListener('click',()=>{ gotoStep(3); populatePreference(); });
back3.addEventListener('click',()=>{ gotoStep(2); });

function typeInto(el, text, interval=40){
  return new Promise(resolve=>{
    el.value = "";
    let i = 0;
    const t = setInterval(()=>{
      el.value += text[i++];
      if(i >= text.length){ clearInterval(t); resolve(); }
    }, interval);
  });
}

async function fauxLoginThenRoute(){
  const uid = document.getElementById('uid');
  const pw  = document.getElementById('pw');


  uid.focus();
  await typeInto(uid, "cassidy.shauna@dpw.gov", 26);
  pw.focus();
  await typeInto(pw, "adjust-normal", 22);

  // enable and submit
  submitBtn.disabled = false;
  // trigger form submit
  document.getElementById('loginForm').dispatchEvent(new Event('submit', {cancelable:true, bubbles:true}));
}


finish.addEventListener('click',()=>{
  const targetPct = 82 + Math.floor(Math.random()*5);
  state.score = scoreForPct(targetPct);
  state.finalized = true;
  updateScoreHint();

  closeModal();
  submitBtn.disabled=false;
  startCaptcha.textContent='Verification complete';
  startCaptcha.classList.add('primary');
  startCaptcha.disabled=true;

  const banner=document.createElement('div');
  const pct=humanPctFromScore(state.score);
  banner.className='notice';
  banner.innerHTML=`<strong>INTERNAL — DO NOT DISTRIBUTE</strong><div class="subtle" style="margin-top:6px">Human likelihood: ${pct}%. This is sufficient for municipal work.</div>`;
  document.querySelector('.wrap').appendChild(banner);
  setTimeout(fauxLoginThenRoute, 500);
});

document.getElementById('loginForm').addEventListener('submit', e => {
  e.preventDefault();
  const id=(document.getElementById('uid').value||'').trim();
  const ok=!submitBtn.disabled && id.length>0; if(!ok) return;

  const overlay=document.createElement('div'); overlay.className='modal open';
  overlay.innerHTML=`<div class="sheet"><div class="bar"><div class="title">Routing</div></div>
  <div class="content"><p class="muted">Do not attempt to see the whole picture.</p>
  <p class="ok">Status: contained, neutralized, or unnoticeable — any is acceptable.</p>
  <p class="muted">You may close this window.</p></div></div>`;
  document.body.appendChild(overlay);

  // auto-close overlay and route to mail
  setTimeout(()=>{
    overlay.remove();
    goToMail();
  }, 900);

  // still allow manual close early
  setTimeout(()=>{ overlay.addEventListener('click',()=>{ overlay.remove(); goToMail(); }); }, 200);
});


document.addEventListener('keydown', (e)=>{
  if(e.key==='Escape'&&modal.classList.contains('open')) closeModal();
  if(e.key==='Enter' && steps[2].classList.contains('active')) checkTyping();
});

/* ===== FAUX MAIL: one-by-one delivery ===== */
const mailUI = {
  root: document.getElementById('mail'),
  list: document.getElementById('mailList'),
  from: document.getElementById('mFrom'),
  subj: document.getElementById('mSubj'),
  when: document.getElementById('mWhen'),
  body: document.getElementById('mBody'),
  sel:  document.getElementById('classSel'),
  file: document.getElementById('fileMail'),
  score:document.getElementById('mScore'),
  lock: document.getElementById('lock')
};

const NEXT_DELAY_MS = 900; // set to 0 for immediate delivery

// Full pool
const POOL = [
  {from:"Onboarding <r-noreply@dpw>", when:"Mon 08:12", subj:"Welcome Routing Exercises",
   body:`You will file incoming messages using official Bureau designations.

Ashford - Tangible anomaly  (A = "Actual")
Brimstone - Spatial irregularity  (B = "Border")
Crosscut - Informational anomaly  (C = "Cognitive")
Dovetail - Concious anomaly  (D = "Denizen")
Everest - Benign or explainable  (E = "Easy")
Furnace - Severe hazard  (F = "Fire")
Zero Hour - Catastrophic  (Z = "Zero")

Select the correct designation for each message and file it.
This is the only message that includes mnemonics. Feel free to file this as "Everest" if you are certain you have memorized these.`,
   ans:"Everest", tag:"TRAIN"},

  {from:"Field Asset 24B (Library) <fa24b@boa.int>", when:"Mon 08:19", subj:"Magnetic drift brick",
   body:`The brick recovered from the west wing archive is no longer inert. It gives off a faint hum you can feel more than hear. Every compass tested points directly at it, even my wristwatch hand swings toward the bag.
Stored it in canvas and plastic layers but the pull persists. One of the interns put their ear to it and said it sounded like "breathing."`,
   ans:"Ashford"},

  {from:"Field Asset 07F (Subway Maintenance) <fa07f@boa.int>", when:"Mon 08:27", subj:"Updraft from capped shaft",
   body:`Dust along Corridor 2B began lifting into the air as if a breeze came up from below. Confirmed airflow with meter. Source is a maintenance shaft sealed since the 1970s.
Cap is welded, no breach visible. Air is dry and mineral-smelling but with a faint sweetness, almost like honey. The shift partner refused to stay near it.`,
   ans:"Brimstone"},

  {from:"Field Asset 19C (Transit Ops) <fa19c@boa.int>", when:"Mon 08:41", subj:"Stub sorter movement",
   body:`Working alone on night shift, clearing the stub tray. One stub slid across the desk by itself and arranged neatly at the edge. Others followed in sequence, sorted themselves into piles by destination.
Playback confirms movement with no visible cause. No shadows shifting either.`,
   ans:"Ashford"},

  {from:"Field Asset 04G (Water Services) <fa04g@boa.int>", when:"Mon 08:50", subj:"Persistent avian pursuit",
   body:`Requesting Dovetail classification. For the past three mornings a single duck has followed me from my apartment to the reservoir gate. It keeps pace whether I walk or take the bus. When I stop, it stops. It waits outside job sites until I come out again.
I understand protocol, but I am certain this is not coincidence. The bird looks directly at me every time I turn. I cannot shake the sense it is observing.
Please escalate to Dovetail. I repeat: this is not benign.`,
   ans:"Everest"},

  {from:"Field Asset 11D (Platform Security) <fa11d@boa.int>", when:"Mon 08:55", subj:"Porcelain masks Platform 3",
   body:`Two individuals in porcelain masks were observed standing by the far bench for eighteen minutes. Both completely motionless. Ambient sound from the feed cut to zero while they were present.
At 08:54, one figure turned directly toward the security camera. Unable to confirm eye presence behind the mask.`,
   ans:"Dovetail"},

  {from:"Field Asset 31E (Parks Facility) <fa31e@boa.int>", when:"Mon 09:04", subj:"Locker odor",
   body:`Locker 14B smells strongly of rain after every cleaning. No moisture readings. No leaks. Ventilation is intact and dry.
Janitor confirms odor appears even after locker has been propped open all night. Harmless but persistent.`,
   ans:"Everest"},

  {from:"Field Asset 06C (City Records) <fa06c@boa.int>", when:"Mon 09:18", subj:"Unfiled note insertion",
   body:`Discovered a line in case file 87-403 I did not author: "You will be here again." Same handwriting appeared in three unrelated case files across the office.
All staff deny authorship. Security logs show no after-hours access. Colleagues increasingly uneasy.`,
   ans:"Crosscut"},

  {from:"Field Asset 04G (Water Services) <fa04g@boa.int>", when:"Mon 09:22", subj:"Escalation of avian presence",
   body:`Following up on prior report. The same duck was waiting outside the north treatment plant this morning. I left through a different exit, but it was already across the street when I arrived. It crossed against traffic without hesitation and did not break eye contact.
Coworkers insist it is "just a bird," but they did not see the way it adjusted its pace to mine. I am convinced this is targeted pursuit. Reiterating request for Dovetail classification. This cannot be Everest.`,
   ans:"Everest"},

  {from:"Field Asset 12B (Elevator Tech) <fa12b@boa.int>", when:"Mon 09:26", subj:"Instant arrival Annex lift",
   body:`While servicing Annex lift, passenger requested floor 6. Doors closed, immediately reopened, and we were already on floor 6. Drum counters still marked us at floor 1.
Passenger laughed, assumed a "magic trick." Equipment shows no fault. I have serviced these units eighteen years and never seen this.`,
   ans:"Brimstone"},

  {from:"Field Asset 09C (unknown) <fa09c@boa.int>", when:"Mon 09:38", subj:"None",
   body:`I recognize the bodies in the water.
I recognize the bodies in the water.
I recognize the bodies in the water.
I recognize the bodies in the water.
I recognize the bodies in the water.
I recognize the bodies in the water.
I recognize the bodies in the water.
I recognize the bodies in the water.
I recognize the bodies in the water.
I recognize the bodies in the water.`,
   ans:"Crosscut"},

  {from:"Field Asset 15A (Street Lighting) <fa15a@boa.int>", when:"Mon 09:52", subj:"Lamp rotation",
   body:`Streetlamp at 14th and Wren is rotated 180 degrees every morning, facing away from the crosswalk. Reset twice this week. Bolts on the mount are rusted solid, unmovable by hand.
Weather calm, no storms recorded.`,
   ans:"Ashford"},

  {from:"Field Asset 04G (Water Services) <fa04g@boa.int>", when:"Mon 09:54", subj:"Resolution with avian presence",
   body:`Update. The duck and I have reached an understanding. It no longer follows at a distance. It walks beside me. We stop together at crosswalks.
I spoke aloud to it. It inclined its head as if listening. Since then I feel calmer. The sense of being observed is still present, but I no longer find it unwelcome.
Please file this as Everest as closure to previous reports.`,
   ans:"Crosscut"},

  {from:"Field Asset 17Q (Utilities) <fa17q@boa.int>", when:"Mon 09:58", subj:"Radio interference",
   body:`Utilities hotline received two complaints of FM radio being overridden by a flat male voice repeating "It is happening." I tuned my own radio and confirmed. Phrase repeated until frequency was changed.
No known municipal broadcast on that channel. Treating as interference for now. Filing Everest as precaution.`,
   ans:"Everest"},

  {from:"Field Asset 05F (Concourse Patrol) <fa05f@boa.int>", when:"Mon 10:01", subj:"Disappearance porcelain masks",
   body:`Observed three masked figures walking in formation through Concourse B. Middle figure abruptly broke line and approached a commuter before vanishing mid-stride.
Commuter blinked, resumed walking as if nothing occurred. Later denied seeing any masked figures.`,
   ans:"Dovetail"},

  {from:"Field Asset 22E (Transit Display Ops) <fa22e@boa.int>", when:"Mon 10:06", subj:"Signboard flicker",
   body:`Five bus signs in District 7 blanked simultaneously for thirty seconds before restoring. Drivers report faint afterimage text, unreadable but white against black.
No public complaints received. Filing Everest as likely equipment fault.`,
   ans:"Everest"},

  {from:"Field Asset 00Z (Emergency Response) <fa00z@boa.int>", when:"Mon 10:13", subj:"URGENT",
   body:`All municipal display boards now show the phrase IT IS HAPPENING. Every tuned radio carries the same words in a flat male voice. Cutting local power has no effect.
Hospitals confirm patient monitors ticking in unison across wards regardless of condition. Traffic control reports signals citywide fixed green, collisions ongoing.
Pedestrians visible on traffic feeds stand frozen mid-step, all oriented northeast. Drivers remain seated in vehicles, breathing but unresponsive. My own street included.
Attempted to rouse a neighbor. No reaction. He only stares northeast.
Broadcast has shifted to a new word. BEGINNING. Repeated without pause.
This is not Everest.`,
   ans:"Zero Hour", tag:"Z"}
];


// inbox shows arrived messages; queue holds undelivered pool
let inbox = [];
let queue = [];
let cur = 0, mailScore = 0;

function initMail(){
  queue = POOL.slice(1);    // everything after training
  inbox = [ POOL[0] ];      // start with training email
  cur = 0; mailScore = 0;
  mailUI.score.textContent='0';
  renderList(); renderMail();
  deliverNext();
}

function renderList(){
  mailUI.list.innerHTML='';
  if(inbox.length===0){
    const empty=document.createElement('div');
    empty.className='item';
    empty.innerHTML='<div class="subj">No messages</div><div class="meta"><span>Routing</span><span class="tag">—</span></div>';
    mailUI.list.appendChild(empty);
    return;
  }
  inbox.forEach((m,idx)=>{
    const li=document.createElement('div');
    li.className='item'+(idx===cur?' active':'');
    li.setAttribute('role','option');
    li.innerHTML = `
      <div class="subj">${m.subj}</div>
      <div class="meta">
        <span>${m.from.split(' ')[0]}</span>
        <span class="tag">${m.when}</span>
      </div>`;
    li.addEventListener('click',()=>{cur=idx; renderMail();});
    mailUI.list.appendChild(li);
  });
}

function renderMail(){
  if(inbox.length===0){
    mailUI.from.textContent='Routing';
    mailUI.subj.textContent='Awaiting next message';
    mailUI.when.textContent='—';
    mailUI.body.textContent='Stand by for further routing.';
    mailUI.sel.value='';
    mailUI.file.disabled = true;
    return;
  }
  const m = inbox[cur];
  [...mailUI.list.children].forEach((c,i)=>c.classList.toggle('active',i===cur));
  mailUI.from.textContent = m.from;
  mailUI.subj.textContent = m.subj;
  mailUI.when.textContent = m.when;
  mailUI.body.textContent = m.body;
  mailUI.sel.value='';
  mailUI.file.disabled = true;
}

mailUI.sel.addEventListener('change',()=>{ mailUI.file.disabled = (mailUI.sel.value===''); });

mailUI.file.addEventListener('click', ()=>{
  if(inbox.length===0) return;
  const chosen = mailUI.sel.value;
  const expected = inbox[cur].ans;

  // handle Zero Hour immediately
  if (expected === 'Zero Hour' && chosen === 'Zero Hour'){
    triggerLockout();
    return;
  }

  if (chosen === expected) mailScore += 10;
  mailUI.score.textContent = String(mailScore);

  // remove the filed message from inbox
  inbox.splice(cur,1);

  // reset selection and viewer to waiting state
  cur = Math.max(0, Math.min(cur, inbox.length-1));
  renderList(); renderMail();

  // deliver the next item after a delay (if any)
  deliverNext();
});

function deliverNext(){
  if(queue.length===0) return;
  setTimeout(()=>{
    const next = queue.shift();
    const wasEmpty = inbox.length === 0;
    inbox.push(next);
    if (wasEmpty) cur = 0;

    renderList(); renderMail();
  }, NEXT_DELAY_MS);
}

function triggerLockout(){
  setTimeout(()=>{
    mailUI.lock.classList.add('open');
    document.querySelectorAll('button,select,input').forEach(el=>el.disabled=true);
  }, 250);
}

function goToMail(){
  document.querySelector('.card')?.setAttribute('hidden','hidden');
  document.querySelector('.notice')?.setAttribute('hidden','hidden');
  mailUI.root.classList.add('open');
  initMail();
}

// === HEY REN, I KNOW YOU'RE LOOKING. Click the sigil to skip the humanity check. ===
document.querySelector('.sigil').addEventListener('click', e => {
  e.preventDefault();
  goToMail();
});
</script>

</body>
</html>
